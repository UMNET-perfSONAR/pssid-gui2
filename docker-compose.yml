version: '3.8'

services:
  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - internal
  client:
    image: pssid-gui2_client:latest
    build: ./services/client
    volumes:
      - ./services/client/src:/usr/src/app/client/src
      - client_node_modules:/usr/src/app/client/node_modules
      - ./shared:/usr/src/app/client/src/shared:ro
      # - ./certs/pssid-web-dev.miserver.it.umich.edu.pem:/usr/src/app/certs/pssid-web-dev.miserver.it.umich.edu.pem
      # - ./certs/pssid-web-dev.miserver.it.umich.edu-key.pem:/usr/src/app/certs/pssid-web-dev.miserver.it.umich.edu-key.pem
    expose:
      - "8080"
    networks:
      internal:
        aliases:
          - client

  server:
    image: pssid-gui2_server:latest
    restart: on-failure
    build: ./services/server
    volumes:
      - ./services/server/src:/usr/src/app/server/src
      - ./services/server/.env:/usr/src/app/server/.env
      - server_node_modules:/usr/src/app/server/node_modules
      - /usr/lib/exec/pssid:/usr/src/app/server/bin
      - /var/lib/pssid/plugins:/usr/src/app/server/plugins
      - /var/lib/pssid/output:/usr/src/app/server/output
      - ./shared:/usr/src/app/server/src/shared:ro
      - ./certs:/etc/letsencrypt:ro
      # - ./certs/pssid-web-dev.miserver.it.umich.edu.pem:/usr/src/app/server/pssid-web-dev.miserver.it.umich.edu.pem
      # - ./certs/pssid-web-dev.miserver.it.umich.edu-key.pem:/usr/src/app/server/pssid-web-dev.miserver.it.umich.edu-key.pem
    expose:
      - "8000"
    depends_on:
      - mongo
      - redis
    networks:
      internal:
        aliases:
          - server
  mongo:
    image: pssid-gui2_mongo:latest
    build: ./services/database
    expose:
      - "27017"
    networks:
      - internal
    volumes:
      - mongo_db:/data/db

  # nginx-proxy-manager:
  #   image: jc21/nginx-proxy-manager:latest
  #   container_name: nginx-proxy-manager
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #     - "81:81"     # Admin panel
  #     - "443:443"
  #   volumes:
  #     - npm_data:/data
  #     - npm_letsencrypt:/etc/letsencrypt
  #   networks:
  #     - internal
  #     - web

  nginx:
    image: nginx:stable-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
      - ./www/certbot:/var/www/certbot
    depends_on:
      - client
      - server
      # - oauth2-proxy
    networks:
      - internal
      - web

  # oauth2-proxy:
  #   image: quay.io/oauth2-proxy/oauth2-proxy:v7.12.0
  #   environment:
  #     OAUTH2_PROXY_PROVIDER: "oidc"
  #     OAUTH2_PROXY_PROVIDER_DISPLAY_NAME: "Shibboleth"
  #     OAUTH2_PROXY_COOKIE_SECURE: "true"
  #     OAUTH2_PROXY_PASS_ACCESS_TOKEN: "true"
  #     OAUTH2_PROXY_EMAIL_DOMAINS: "*"
  #     OAUTH2_PROXY_UPSTREAMS: "http://client:8080"
  #     OAUTH2_PROXY_CLIENT_ID: ${CLIENT_ID}
  #     OAUTH2_PROXY_CLIENT_SECRET: ${CLIENT_SECRET}
  #     OAUTH2_PROXY_COOKIE_SECRET: ${SECRET}
  #     OAUTH2_PROXY_REDIRECT_URL: ${BASE_URL}/callback
  #     OAUTH2_PROXY_OIDC_ISSUER_URL: ${ISSUER_BASE_URL}
  #   ports:
  #     - "4180:4180"
  #   networks:
  #     - internal
  #   depends_on:
  #     - server

  certbot:
    image: certbot/certbot
    volumes:
      - ./certs/:/etc/letsencrypt
      - ./www/certbot:/var/www/certbot
    # entrypoint: /bin/sh -c
    # command: >
    #   "trap exit TERM;
    #   while :; do
    #     certbot rewnew --webroot -w /var/www/certbot;
    #     sleep 12h;
    #   done"

volumes:
  client_node_modules:
  server_node_modules:
  mongo_db:
  npm_data:
  npm_letsencrypt:
  redis_data:

networks:
  internal:
    driver: bridge
  web: